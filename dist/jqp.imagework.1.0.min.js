// @author Dirk Schumacher @see https://github.com/greyshine/jimageworks 
!function(a){var b={lineColor:"#000",canvasBackgroundColor:"#FFF",callbackAngleSelect:function(a,b,c,d,e,f){},callbackPosition1:function(a,b,c){},callbackPosition2:function(a,b,c,d,e,f){},testCanvasId:null},c={callbackPositionSearch:function(a,b,c,d,e){},callbackPosition1:function(a,b,c){},callbackPosition2:function(a,b,c,d,e){},callbackCropped:function(a,b,c,d,e){},testCanvasId:null},d=function(b){var c=a(b.target),d=c.position().left,e=c.position().top;return{x:b.pageX-d,y:b.pageY-e,toString:function(){return this.x+"x"+this.y}}},e=function(a,b,c,d,e,f){a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.strokeStyle=f||"#000",a.stroke()},f=function(a){a.width=a.image.width,a.height=a.image.height,a.ctx.clearRect(0,0,a.width,a.height),a.ctx.drawImage(a.image,0,0)},g=function(a){var b=document.createElement("canvas");return b.ctx=b.getContext("2d"),b.image=a,a.canvas=b,f(b),b},h=function(a,b){a.ctx.fillRect(b.x-3,b.y-3,7,7)},i=function(b){var c=b.toDataURL();return a(b).replaceWith(b.image),b.mode=null,b.click1=null,b.click2=null,b.image.canvas=null,b.image=null,c},j=function(a,b){var c=b.x-a.x,d=b.y-a.y;return c>0&&d>0?4:c>0&&d<0?2:c<0&&d>0?3:c<0&&d<0?1:0},k=function(a,b){var c=j(a,b),d=a,e=b;switch(c){case 1:a={x:e.x,y:e.y},b={x:d.x,y:d.y};break;case 2:a={x:d.x,y:e.y},b={x:e.x,y:d.y};break;case 3:a={x:e.x,y:d.y},b={x:d.x,y:e.y};break;case 0:case 4:a={x:d.x,y:d.y},b={x:e.x,y:e.y}}var f={topLeft:a,bottomRight:b,width:b.x-a.x,height:b.y-a.y,area:this.width*this.height,toString:function(){return"area="+this.area}.bind(this)};return f};a.fn.crop=function(b){for(var e=Object.assign({},c,b),j=function(a,b,c){var d=k(b,c);if(0==d.area)return d;b=d.topLeft,c=d.bottomRight;var e=a.getContext("2d");return e.globalAlpha=.4,e.fillRect(0,0,a.width,b.y),e.fillRect(0,c.y,a.width,c.y),e.fillRect(0,b.y,b.x,c.y-b.y),e.fillRect(c.x,b.y,a.width-c.x,c.y-b.y),d},l=function(a,b,c,d){if(null!=a){var e=k(c,d),f=a,g=b.image;f.width=e.width,f.height=e.height;var h=f.getContext("2d");try{h.drawImage(g,e.topLeft.x,e.topLeft.y,e.width,e.height,0,0,e.width,e.height)}catch(a){}}},m=0,n=this.length;m<n;m++){var o=this[m],p=a(o);if("IMG"==p.prop("tagName"))if(null==o.canvas||null==o.canvas.click2)o.canvas?i(o.canvas):(o.canvas=g(o),o.canvas.mode="crop",o.canvas.click1=null,o.canvas.click2=null,o.canvas.onmousemove=function(a){if(null==this.click1||null!=this.click2)return!0;var b=d(a);f(this),j(this,this.click1,b),h(this,this.click1),h(this,b),null!=e.testCanvasId&&l(document.getElementById(e.testCanvasId),this,this.click1,b),e.callbackPositionSearch(this.image,this.click1.x,this.click1.y,b.x,b.y)}.bind(o.canvas),o.canvas.onclick=function(a){if(null==this.click1)this.click1=d(a),h(this,this.click1),e.callbackPosition1(this.image,this.click1.x,this.click1.y);else if(null==this.click2){this.click2=d(a),f(this);var b=j(this,this.click1,this.click2);this.click1=b.topLeft,this.click2=b.bottomRight,e.callbackPosition2(this.image,this.click1.x,this.click1.y,this.click2.x,this.click2.y)}else this.click1=null,this.click2=null,f(this);return!1}.bind(o.canvas),p.replaceWith(o.canvas));else{var q=k(o.canvas.click1,o.canvas.click2);o.canvas.width=q.width,o.canvas.height=q.height,o.canvas.ctx.clearRect(0,0,o.canvas.width,o.canvas.height),o.canvas.ctx.drawImage(o,q.topLeft.x,q.topLeft.y,q.width,q.height,0,0,q.width,q.height),o.src=o.canvas.toDataURL(),e.callbackCropped(o,o.canvas.click1.x,o.canvas.click1.y,o.canvas.click2.x,o.canvas.click2.y),i(o.canvas)}}return this},a.fn.align=function(c){for(var k=Object.assign({},b,c),l=function(a,b,c){if("number"!=typeof a)return{};if("number"!=typeof b)return{};if("number"!=typeof c)return{};for(c=Math.abs(c);c>=360;)c-=360;switch(c){case 0:case 180:return{x:a,y:b,toString:function(){return this.x+"x"+this.y}};case 90:case 270:return{x:b,y:a,toString:function(){return this.x+"x"+this.y}};case 45:case 135:return{x:Math.sqrt(a*a+b*b),y:this.x,toString:function(){return this.x+"x"+this.y}}}var e=function(a,b){var c=90-b;c/=180/Math.PI;var d=a*Math.cos(c);d=Math.abs(d);var e=Math.sqrt(a*a-d*d);return{a:d,b:e}},f=a,g=b,h=e(f,c),i=e(g,c),j=h.b+i.a,k=h.a+i.b;return{x:j,y:k,toString:function(){return this.x+"x"+this.y}}},m=function(a,b){var c=a.y-b.y,d=a.x-b.x;if(0===d)return 90;if(0===c)return 0;var e=Math.sqrt(c*c+d*d),f=c/e,g=Math.asin(f)*(180/Math.PI),h=j(a,b);return 1!=h&&3!=h||(g*=-1),g},n=function(a,b,c){if(null!=a){var d=a,e=b.image,f=e.width,g=e.height;d.width=Math.sqrt(f*f+g*g),d.height=d.width;var h=l(f,g,c);try{d.width=h.x,d.height=h.y}catch(a){}var i=d.getContext("2d");i.save(),i.clearRect(0,0,d.width,d.height),i.translate(d.width/2,d.height/2),i.rotate(c*Math.PI/180),i.drawImage(e,-e.width/2,-e.height/2),i.restore();var j=document.getElementById("tc2");j.width=Math.sqrt(f*f+g*g),j.height=j.width,ctx2=j.getContext("2d"),ctx2.save(),ctx2.clearRect(0,0,d.width,d.height),ctx2.translate(j.width/2,j.height/2),ctx2.rotate(c*Math.PI/180),ctx2.drawImage(e,-e.width/2,-e.height/2),ctx2.restore()}},o=0,p=this.length;o<p;o++){var q=this[o],r=a(q);if("IMG"==r.prop("tagName")){if(null!=q.canvas&&null!=q.canvas.mode&&"align"!=q.canvas.mode)throw"currently in mode: "+q.canvas.mode;var s=null==q.canvas;if(s||null!=q.canvas.click2)if(s||null==q.canvas.click2){var u=g(q);u.mode="align",u.click1=null,u.click2=null,u.onmousemove=function(a){if(null==this.click1||null!=this.click2)return!0;var b=d(a),c=m(this.click1,b);f(this),e(this.ctx,this.click1.x,this.click1.y,b.x,b.y,k.lineColor),h(this,this.click1),h(this,b),k.callbackAngleSelect(this.image,this.click1.x,this.click1.y,b.x,b.y,c),null!=k.testCanvasId&&n(document.getElementById(k.testCanvasId),this,c)}.bind(u),u.onclick=function(a){if(null!=this.click2)this.click1=null,this.click2=null,f(this);else if(null==this.click1)this.click1=d(a),h(this,this.click1),k.callbackPosition1(this.image,this.click1.x,this.click1.y);else{this.click2=d(a);var b=m(this.click1,this.click2);e(this.ctx,this.click1.x,this.click1.y,this.click2.x,this.click2.y,k.lineColor),h(this,this.click1),h(this,this.click2),k.callbackPosition2(this.image,this.click1.x,this.click1.y,this.click2.x,this.click2.y,b)}return!1}.bind(u),r.replaceWith(u)}else{var t=m(q.canvas.click1,q.canvas.click2);if(0==t)continue;var u=q.canvas,v=u.ctx,w=l(u.width,u.height,t);u.width=w.x,u.height=w.y,v.clearRect(0,0,u.width,u.height),v.fillStyle=k.canvasBackgroundColor,v.fillRect(0,0,tc.width,tc.height),v.save(),v.translate(u.width/2,u.height/2),v.rotate(t*Math.PI/180),v.drawImage(q,-q.width/2,-q.height/2),v.restore(),q.src=q.canvas.toDataURL(),i(q.canvas)}else i(q.canvas)}}return this},a.fn.getBase64=function(){var b=document.createElement("canvas"),c=this[0],d=a(c);if("IMG"!=d.prop("tagName"))return null;b.width=c.width,b.height=c.height;var e=b.getContext("2d");return e.drawImage(c,0,0),b.toDataURL()},a.fn.flip=function(){for(var b=document.createElement("canvas"),c=b.getContext("2d"),d=0,e=this.length;d<e;d++){var f=this[d],g=a(f);"IMG"==g.prop("tagName")&&(b.width=f.width,b.height=f.height,c.translate(0,f.height),c.scale(1,-1),c.drawImage(f,0,0),f.src=b.toDataURL())}return this},a.fn.mirror=function(){for(var b=document.createElement("canvas"),c=b.getContext("2d"),d=0,e=this.length;d<e;d++){var f=this[d],g=a(f);"IMG"==g.prop("tagName")&&(b.width=f.width,b.height=f.height,c.translate(f.width,0),c.scale(-1,1),c.drawImage(f,0,0),f.src=b.toDataURL())}return this},a.fn.rotate=function(){for(var b=document.createElement("canvas"),c=b.getContext("2d"),d=0,e=this.length;d<e;d++){var f=this[d],g=a(f);"IMG"==g.prop("tagName")&&(c.clearRect(0,0,b.width,b.height),b.width=f.height,b.height=f.width,c.translate(b.width/2,b.height/2),c.rotate(Math.PI/2),c.drawImage(f,-f.width/2,-f.height/2),c.rotate(-Math.PI/2),c.translate(-b.width/2,-b.height/2),f.src=b.toDataURL())}return this},a.fn.lotate=function(){for(var b=document.createElement("canvas"),c=b.getContext("2d"),d=0,e=this.length;d<e;d++){var f=this[d],g=a(f);"IMG"==g.prop("tagName")&&(c.clearRect(0,0,b.width,b.height),b.width=f.height,b.height=f.width,c.translate(b.width/2,b.height/2),c.rotate(270*Math.PI/180),c.drawImage(f,-f.width/2,-f.height/2),c.rotate(-270*Math.PI/180),c.translate(-b.width/2,-b.height/2),f.src=b.toDataURL())}return this}}(jQuery);